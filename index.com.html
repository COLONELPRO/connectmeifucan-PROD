<!doctype html>
<html lang="fr" data-app="connectmeifucan-com">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ConnectMeIfUCan • .com Auth</title>
  <link rel="stylesheet" href="Site/theme.css">
  <style>
    :root {
      --bg: #0b0b0b;
      --text: #f5f5f5;
      --muted: #9aa0a6;
      --accent: #ffcc00;
      --accent-hover: #ffd84a;
      --border: rgba(255,255,255,0.12);
      --danger: #ff5463;
      --ok: #2ecc71;
    }
    html, body { height: 100%; }
    body { margin:0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { min-height: 100dvh; display:flex; align-items:center; justify-content:center; padding: 20px; }
    .card { width:min(92%, 640px); border:1px solid var(--border); border-radius: 12px; background: rgba(255,255,255,0.03); box-shadow: 0 24px 64px rgba(0,0,0,0.55); }
    .card .inner { padding: 18px; }
    .brand { display:flex; align-items:center; gap:12px; margin-bottom: 4px; }
    .brand img { width: 56px; height:56px; object-fit:cover; border-radius:10px; border:1px solid var(--border); }
    .brand .name { font-weight: 800; font-size: 1.15rem; }
    .sub { color: var(--muted); font-size: 0.95rem; margin-bottom: 12px; }

    .lang-toggle { display:flex; gap:8px; justify-content:flex-end; margin-bottom: 8px; }
    .lang-toggle button { padding:6px 10px; border-radius:8px; border:1px solid var(--border); background: rgba(255,255,255,0.06); color: var(--text); cursor:pointer; }
    .lang-toggle button.active { background: var(--accent); color:#000; border-color: rgba(0,0,0,0.15); font-weight: 800; }

    .fields { display:flex; gap:10px; align-items:center; }
    .fields input { flex: 1; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); }
    .fields button { padding:10px 12px; border-radius:8px; border:1px solid var(--border); cursor:pointer; background: var(--accent); color:#000; font-weight: 800; }

    .help { color: var(--muted); font-size: 0.9rem; margin-top: 8px; }
    .status { margin-top: 10px; font-size: 0.95rem; }
    .status.error { color: var(--danger); }
    .status.ok { color: var(--ok); }

    .divider { margin: 16px 0; height:1px; background: var(--border); }

    .hidden { display:none; }
    .actions { display:flex; gap:8px; justify-content:flex-end; }
    .actions .secondary { background: transparent; color: var(--text); }

    .footer { margin-top: 16px; color: var(--muted); font-size: 0.85rem; display:flex; justify-content:space-between; }
    .footer a { color: var(--accent); text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-label="Auth card">
      <div class="inner">
        <div class="lang-toggle" aria-label="Langue / Language">
          <button id="btn-fr" class="active">FR</button>
          <button id="btn-en">EN</button>
        </div>
        <div class="brand">
          <img src="connectmeifucan-logo-Noel.jpg" alt="Logo">
          <div class="name">Connect Me If U Can</div>
        </div>
        <div id="copy-fr" class="sub">Bienvenue sur la version .com. Entrez votre pseudo pour vous connecter ou créer un compte.</div>
        <div id="copy-en" class="sub hidden">Welcome to the .com version. Enter your username to sign in or create an account.</div>

        <div class="fields" aria-label="Pseudo entry">
          <input id="input-username" type="text" placeholder="Pseudo" aria-label="Votre pseudo">
          <button id="btn-continue">Continuer</button>
        </div>
        <div id="help-fr" class="help">Votre pseudo sera vérifié. S'il n'existe pas, vous pourrez créer un compte.</div>
        <div id="help-en" class="help hidden">Your username will be verified. If it does not exist, you can create an account.</div>

        <div id="code-area" class="hidden" aria-label="Code verification">
          <div id="code-copy-fr" class="help">Entrez votre code d'accès pour continuer.</div>
          <div id="code-copy-en" class="help hidden">Enter your access code to continue.</div>
          <div class="fields">
            <input id="input-code" type="text" placeholder="Code d'accès" aria-label="Votre code">
            <button id="btn-verify">Vérifier</button>
          </div>
        </div>

        <div id="status" class="status"></div>
        <div class="divider"></div>
        <div id="create-area" class="hidden">
          <div id="create-copy-fr" class="help">Ce pseudo n'existe pas. Souhaitez-vous créer un compte ?</div>
          <div id="create-copy-en" class="help hidden">This username does not exist. Would you like to create an account?</div>
          <div class="actions">
            <button id="btn-create" class="primary">Créer</button>
            <button id="btn-cancel" class="secondary">Annuler</button>
          </div>
        </div>

        <div id="welcome" class="hidden">
          <div id="welcome-fr" class="help">Authentifié. Bienvenue !</div>
          <div id="welcome-en" class="help hidden">Authenticated. Welcome!</div>
        </div>

        <div class="footer">
          <div>Besoin d'aide ? <a href="mailto:support@connectmeifucan.com">support@connectmeifucan.com</a></div>
          <div><a href="https://connectmeifucan.app" target="_blank" rel="noopener">Version Android TV</a></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = localStorage.getItem('cmuc_api_base') || 'https://api.connectmeifucan.com';
    const STATUS = document.getElementById('status');
    const input = document.getElementById('input-username');
    const btnContinue = document.getElementById('btn-continue');
    const USE_MOCK = /[?&]mock=1/.test(location.search);
    const btnCreate = document.getElementById('btn-create');
    const btnCancel = document.getElementById('btn-cancel');

    const btnFR = document.getElementById('btn-fr');
    const btnEN = document.getElementById('btn-en');

    // ===== SECURITY: Input Sanitization =====
    function sanitizeInput(input, maxLength = 100) {
      if (typeof input !== 'string') return '';
      return input
        .trim()
        .slice(0, maxLength)
        .replace(/[<>"'`]/g, '') // Remove XSS chars
        .replace(/javascript:/gi, '')
        .replace(/on\w+=/gi, '')
        .replace(/\0/g, '');
    }
    
    function isValidUsername(username) {
      return typeof username === 'string' && /^[a-zA-Z0-9_-]{3,20}$/.test(username);
    }
    
    function isValidAccessCode(code) {
      return typeof code === 'string' && /^[A-Z0-9]{4,20}$/.test(code);
    }

    const frBlocks = ['copy-fr','help-fr','create-copy-fr','welcome-fr'];
    const enBlocks = ['copy-en','help-en','create-copy-en','welcome-en'];

    function setLang(lang){
      document.documentElement.lang = lang;
      localStorage.setItem('cmuc_lang', lang);
      const isFR = lang === 'fr';
      btnFR.classList.toggle('active', isFR);
      btnEN.classList.toggle('active', !isFR);
      frBlocks.forEach(id => document.getElementById(id).classList.toggle('hidden', !isFR));
      enBlocks.forEach(id => document.getElementById(id).classList.toggle('hidden', isFR));
      input.placeholder = isFR ? 'Pseudo' : 'Username';
      btnContinue.textContent = isFR ? 'Continuer' : 'Continue';
      btnCreate.textContent = isFR ? 'Créer' : 'Create';
      btnCancel.textContent = isFR ? 'Annuler' : 'Cancel';
      const codeInput = document.getElementById('input-code');
      const btnVerify = document.getElementById('btn-verify');
      if (codeInput) codeInput.placeholder = isFR ? "Code d'accès" : 'Access code';
      if (btnVerify) btnVerify.textContent = isFR ? 'Vérifier' : 'Verify';
    }

    setLang(localStorage.getItem('cmuc_lang') || 'fr');
    btnFR.addEventListener('click', ()=> setLang('fr'));
    btnEN.addEventListener('click', ()=> setLang('en'));

    function showStatus(text, kind){ STATUS.textContent = text; STATUS.className = 'status ' + (kind||''); }
    function clearStatus(){ showStatus('', ''); }
    function showCreateArea(show){ document.getElementById('create-area').classList.toggle('hidden', !show); }
    function showWelcome(show){ document.getElementById('welcome').classList.toggle('hidden', !show); }

    async function checkUsername(username){
      if (USE_MOCK){
        // Mocked responses: demo=access, needcode=existing but needs code, newcode=new user requires code to create
        const map = {
          demo: { exists: true, hasAccess: true, requireCode: false, requiresCodeForCreate: false },
          needcode: { exists: true, hasAccess: false, requireCode: true, requiresCodeForCreate: false },
          newcode: { exists: false, hasAccess: false, requireCode: true, requiresCodeForCreate: true }
        };
        const res = map[username.toLowerCase()] || { exists: false, hasAccess: false, requireCode: false, requiresCodeForCreate: false };
        return new Promise(resolve => setTimeout(() => resolve(res), 300));
      }
      try {
        const r = await fetch(API_BASE + '/auth/check', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username }) });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        return {
          exists: !!data.exists,
          hasAccess: !!data.hasAccess,
          requireCode: !!data.requireCode,
          requiresCodeForCreate: !!data.requiresCodeForCreate
        };
      } catch (e) {
        console.error('checkUsername failed', e);
        throw e;
      }
    }

    async function createAccount(username, code){
      if (USE_MOCK){
        const ok = !!code || username.toLowerCase() === 'demo';
        return new Promise((resolve, reject) => setTimeout(() => ok ? resolve({ ok: true, token: 'mock-token' }) : reject(new Error('Create failed')), 300));
      }
      try {
        const payload = code ? { username, code } : { username };
        const r = await fetch(API_BASE + '/auth/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        if (!data.ok) throw new Error('Create failed');
        return data;
      } catch (e) {
        console.error('createAccount failed', e);
        throw e;
      }
    }

    async function verifyAccess(username, code){
      if (USE_MOCK){
        const ok = !!code && code.length >= 4;
        return new Promise((resolve, reject) => setTimeout(() => ok ? resolve({ ok: true, token: 'mock-token' }) : reject(new Error('Verify failed')), 300));
      }
      try {
        const r = await fetch(API_BASE + '/auth/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, code }) });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        if (!data.ok) throw new Error('Verify failed');
        return data;
      } catch (e){
        console.error('verifyAccess failed', e);
        throw e;
      }
    }

    function goToApp(){
      try {
        window.location.href = 'index.html';
      } catch (e){
        console.warn('Redirect failed, staying on page', e);
      }
    }

    function saveAuth(username, token){
      const payload = { username, token, ts: Date.now() };
      localStorage.setItem('cmuc_auth_v1', JSON.stringify(payload));
    }

    async function handleContinue(){
      const username = sanitizeInput(input.value || '', 20);
      const isFR = (localStorage.getItem('cmuc_lang') || 'fr') === 'fr';
      if (!username){ showStatus(isFR ? 'Entrez un pseudo.' : 'Enter a username.', 'error'); return; }
      
      // Validate username format
      if (!isValidUsername(username)) {
        showStatus(isFR ? 'Format invalide. Utilisez 3-20 caractères alphanumériques.' : 'Invalid format. Use 3-20 alphanumeric characters.', 'error');
        return;
      }
      
      clearStatus(); showStatus(isFR ? 'Vérification en cours…' : 'Checking…');
      btnContinue.disabled = true;
      try {
        const info = await checkUsername(username);
        if (info.exists){
          if (info.hasAccess && !info.requireCode){
            showStatus(isFR ? 'Accès autorisé. Authentification…' : 'Access allowed. Authenticating…');
            saveAuth(username, 'token-demo');
            showCreateArea(false);
            showWelcome(true);
            goToApp();
          } else {
            showStatus(isFR ? 'Code requis pour accéder.' : 'Access code required.', 'error');
            document.getElementById('code-area').classList.remove('hidden');
            showCreateArea(false);
            showWelcome(false);
          }
        } else {
          showStatus(isFR ? "Ce pseudo n'existe pas." : 'This username does not exist.', 'error');
          if (info.requiresCodeForCreate){ document.getElementById('code-area').classList.remove('hidden'); }
          showCreateArea(true);
          showWelcome(false);
        }
      } catch (e){
        showStatus(isFR ? 'Erreur réseau. Réessayez.' : 'Network error. Please retry.', 'error');
      } finally {
        btnContinue.disabled = false;
      }
    }

    async function handleVerify(){
      const username = sanitizeInput(input.value || '', 20);
      const code = sanitizeInput(document.getElementById('input-code').value || '', 20).toUpperCase();
      const isFR = (localStorage.getItem('cmuc_lang') || 'fr') === 'fr';
      
      if (!username){ showStatus(isFR ? 'Entrez un pseudo.' : 'Enter a username.', 'error'); return; }
      if (!code){ showStatus(isFR ? "Entrez votre code d'accès." : 'Enter your access code.', 'error'); return; }
      
      // Validate formats
      if (!isValidUsername(username)) {
        showStatus(isFR ? 'Format de pseudo invalide.' : 'Invalid username format.', 'error');
        return;
      }
      if (!isValidAccessCode(code)) {
        showStatus(isFR ? 'Format de code invalide.' : 'Invalid code format.', 'error');
        return;
      }
      
      clearStatus(); showStatus(isFR ? 'Vérification du code…' : 'Verifying code…');
      document.getElementById('btn-verify').disabled = true;
      try {
        const res = await verifyAccess(username, code);
        saveAuth(username, res.token || 'token-demo');
        showStatus(isFR ? 'Accès validé.' : 'Access verified.', 'ok');
        showCreateArea(false);
        showWelcome(true);
        document.getElementById('code-area').classList.add('hidden');
        goToApp();
      } catch (e){
        showStatus(isFR ? 'Code invalide.' : 'Invalid code.', 'error');
      } finally {
        document.getElementById('btn-verify').disabled = false;
      }
    }

    async function handleCreate(){
      const username = sanitizeInput(input.value || '', 20);
      const isFR = (localStorage.getItem('cmuc_lang') || 'fr') === 'fr';
      
      if (!username){ showStatus(isFR ? 'Entrez un pseudo.' : 'Enter a username.', 'error'); return; }
      
      // Validate username
      if (!isValidUsername(username)) {
        showStatus(isFR ? 'Format de pseudo invalide.' : 'Invalid username format.', 'error');
        return;
      }
      
      const code = sanitizeInput(document.getElementById('input-code')?.value || '', 20).toUpperCase();
      
      // Validate code if provided
      if (code && !isValidAccessCode(code)) {
        showStatus(isFR ? 'Format de code invalide.' : 'Invalid code format.', 'error');
        return;
      }
      
      clearStatus(); showStatus(isFR ? 'Création du compte…' : 'Creating account…');
      btnCreate.disabled = true;
      try {
        const res = await createAccount(username, code);
        saveAuth(username, res.token || 'token-demo');
        showStatus(isFR ? 'Compte créé et authentifié.' : 'Account created and authenticated.', 'ok');
        showCreateArea(false);
        showWelcome(true);
        goToApp();
      } catch (e){
        showStatus(isFR ? 'Impossible de créer le compte.' : 'Unable to create account.', 'error');
      } finally {
        btnCreate.disabled = false;
      }
    }

    function handleCancel(){ clearStatus(); showCreateArea(false); }

    btnContinue.addEventListener('click', handleContinue);
    input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ handleContinue(); } });
    btnCreate.addEventListener('click', handleCreate);
    btnCancel.addEventListener('click', handleCancel);
    document.getElementById('btn-verify').addEventListener('click', handleVerify);
  </script>
</body>
</html>
